<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Malaysia — Forest Reserve (Interactive)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
    <style>
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        margin: 16px;
      }
      #vis {
        max-width: 1400px;
        margin: 0 auto;
      }
    </style>
  </head>
  <body>
    <div id="vis"></div>

    <script>
      const STATES_GEOJSON_URL =
        "https://raw.githubusercontent.com/wantedWaffleInUni/dv2/main/geoBoundaries-MYS-ADM1.geojson";
      const STATE_CENTROIDS = [
        { state_norm: "Johor", lon: 103.5, lat: 1.8 },
        { state_norm: "Kedah", lon: 100.5, lat: 6.2 },
        { state_norm: "Kelantan", lon: 102.1, lat: 5.3 },
        { state_norm: "Melaka", lon: 102.3, lat: 2.25 },
        { state_norm: "Negeri Sembilan", lon: 102.1, lat: 2.7 },
        { state_norm: "Pahang", lon: 102.5, lat: 3.8 },
        { state_norm: "Perak", lon: 101.0, lat: 4.8 },
        { state_norm: "Perlis", lon: 100.2, lat: 6.6 },
        { state_norm: "Pulau Pinang", lon: 100.33, lat: 5.33 },
        { state_norm: "Sabah", lon: 116.7, lat: 5.8 },
        { state_norm: "Sarawak", lon: 113.5, lat: 2.5 },
        { state_norm: "Selangor", lon: 101.5, lat: 3.2 },
        { state_norm: "Terengganu", lon: 103.1, lat: 5.3 },
        { state_norm: "W.P. Kuala Lumpur", lon: 101.7, lat: 3.14 },
        { state_norm: "W.P. Putrajaya", lon: 101.7, lat: 2.93 },
        { state_norm: "W.P. Labuan", lon: 115.25, lat: 5.3 },
      ];

      // helper to normalise state names in CSV
      const nameNormalize =
        "replace(replace(replace(replace(replace(replace(replace(" +
        "toString(datum.state)," +
        "'Malacca','Melaka')," +
        "'Penang','Pulau Pinang')," +
        "'Kuala Lumpur','W.P. Kuala Lumpur')," +
        "'Labuan','W.P. Labuan')," +
        "'Putrajaya','W.P. Putrajaya')," +
        "'N. Sembilan','Negeri Sembilan')," +
        "'Kuala Lumpur Federal Territory','W.P. Kuala Lumpur')";

      const spec = {
        $schema: "https://vega.github.io/schema/vega-lite/v5.json",
        spacing: 24,

        /* >>> MOVE PARAMS TO TOP-LEVEL <<< */
        params: [
          {
            name: "yr",
            value: 2015,
            bind: {
              input: "range",
              name: "Year: ",
              min: 2003,
              max: 2021,
              step: 1,
            },
          },
          {
            name: "sel_state",
            value: "All",
            bind: {
              input: "select",
              name: " Focus state: ",
              options: [
                "All",
                "Johor",
                "Kedah",
                "Kelantan",
                "Melaka",
                "Negeri Sembilan",
                "Pahang",
                "Perak",
                "Perlis",
                "Pulau Pinang",
                "Sabah",
                "Sarawak",
                "Selangor",
                "Terengganu",
                "W.P. Kuala Lumpur",
                "W.P. Putrajaya",
                "W.P. Labuan",
              ],
            },
          },
        ],

        vconcat: [
          /* ====================== TOP: MAP ====================== */
          {
            width: 1400,
            height: 520,
            padding: { top: 40, right: 8, bottom: 0, left: 8 }, // More top, less bottom
            bounds: "full",
            config: {
              autosize: { type: "fit", contains: "padding" },
              view: { clip: false }, // don't clip marks at chart edges
            },

            projection: { type: "mercator", center: [109.5, 4.5], scale: 2000 },
            layer: [
              // Borders
              {
                data: {
                  url: STATES_GEOJSON_URL,
                  format: { type: "json", property: "features" },
                },
                mark: {
                  type: "geoshape",
                  fill: null,
                  stroke: "#0b132b",
                  strokeWidth: 1.2,
                },
              },
              // Circles
              {
                data: { url: "forest_reserve_state.csv" },
                transform: [
                  { calculate: nameNormalize, as: "state_norm" },
                  {
                    calculate: "toNumber(slice(toString(datum.date),0,4))",
                    as: "year",
                  },
                  { filter: "isFinite(datum.year) && datum.year == yr" },
                  { calculate: "toNumber(datum.area)", as: "area_num" },
                  { filter: "isFinite(datum.area_num)" },
                  {
                    lookup: "state_norm",
                    from: {
                      data: { values: STATE_CENTROIDS },
                      key: "state_norm",
                      fields: ["lon", "lat"],
                    },
                  },
                  { filter: "isFinite(datum.lon) && isFinite(datum.lat)" },
                ],
                mark: {
                  type: "circle",
                  stroke: "#0f172a",
                  strokeWidth: 0.6,
                  opacity: 0.9,
                },
                encoding: {
                  longitude: { field: "lon", type: "quantitative" },
                  latitude: { field: "lat", type: "quantitative" },
                  size: {
                    field: "area_num",
                    type: "quantitative",
                    scale: { type: "sqrt", range: [20, 2000] },
                    legend: { title: "Area (ha)" },
                  },
                  color: {
                    field: "area_num",
                    type: "quantitative",
                    scale: { scheme: "greens" },
                    legend: { title: "Area (ha)" },
                  },
                  opacity: {
                    condition: {
                      test: "sel_state == 'All' || datum.state_norm == sel_state",
                      value: 1,
                    },
                    value: 0.25,
                  },
                  tooltip: [
                    { field: "state_norm", title: "State" },
                    { field: "year", type: "quantitative" },
                    {
                      field: "area_num",
                      type: "quantitative",
                      title: "Area (ha)",
                      format: ",",
                    },
                  ],
                },
              },
              // Max annotation
              {
                data: { url: "forest_reserve_state.csv" },
                transform: [
                  { calculate: nameNormalize, as: "state_norm" },
                  {
                    calculate: "toNumber(slice(toString(datum.date),0,4))",
                    as: "year",
                  },
                  { filter: "isFinite(datum.year) && datum.year == yr" },
                  { calculate: "toNumber(datum.area)", as: "area_num" },
                  { filter: "isFinite(datum.area_num)" },
                  {
                    joinaggregate: [
                      { op: "max", field: "area_num", as: "maxArea" },
                    ],
                  },
                  { filter: "datum.area_num == datum.maxArea" },
                  {
                    lookup: "state_norm",
                    from: {
                      data: { values: STATE_CENTROIDS },
                      key: "state_norm",
                      fields: ["lon", "lat"],
                    },
                  },
                ],
                layer: [
                  {
                    mark: {
                      type: "text",
                      dy: -16,
                      fontWeight: "bold",
                      fill: "#065f46",
                    },
                    encoding: {
                      longitude: { field: "lon" },
                      latitude: { field: "lat" },
                      text: { field: "state_norm" },
                    },
                  },
                  {
                    mark: { type: "text", dy: 0, fill: "#065f46" },
                    encoding: {
                      longitude: { field: "lon" },
                      latitude: { field: "lat" },
                      text: {
                        field: "area_num",
                        type: "quantitative",
                        format: ",",
                      },
                    },
                  },
                ],
              },
            ],
          },

          /* ====================== BOTTOM: TIME-SERIES ====================== */
          {
            width: 1400,
            height: 260,
            title:
              "Trend — Selected state (or Malaysia total) with year marker",
            layer: [
              {
                data: { url: "forest_reserve_state.csv" },
                transform: [
                  { calculate: nameNormalize, as: "state_norm" },
                  {
                    calculate: "toNumber(slice(toString(datum.date),0,4))",
                    as: "year",
                  },
                  { filter: "isFinite(datum.year)" },
                  {
                    filter:
                      "sel_state == 'All' || datum.state_norm == sel_state",
                  },
                  { calculate: "toNumber(datum.area)", as: "area_num" },
                  { filter: "isFinite(datum.area_num)" },
                  {
                    aggregate: [
                      { op: "sum", field: "area_num", as: "area_sum" },
                    ],
                    groupby: ["year"],
                  },
                ],
                mark: { type: "line" },
                encoding: {
                  x: {
                    field: "year",
                    type: "quantitative",
                    axis: { title: null, tickCount: 10, format: "d" }, // integer years
                    sort: "ascending",
                  },
                  y: {
                    field: "area_sum",
                    type: "quantitative",
                    title: "Area (ha)",
                  },
                  tooltip: [
                    {
                      field: "year",
                      type: "quantitative",
                      title: "Year",
                      format: "d",
                    },
                    {
                      field: "area_sum",
                      type: "quantitative",
                      title: "Area (ha)",
                      format: ",",
                    },
                  ],
                },
              },
              // Vertical rule at slider year
              {
                data: { url: "forest_reserve_state.csv" },
                transform: [
                  { calculate: nameNormalize, as: "state_norm" },
                  {
                    calculate: "toNumber(slice(toString(datum.date),0,4))",
                    as: "year",
                  },
                  { filter: "isFinite(datum.year)" },
                  {
                    filter:
                      "sel_state == 'All' || datum.state_norm == sel_state",
                  },
                  { calculate: "toNumber(datum.area)", as: "area_num" },
                  { filter: "isFinite(datum.area_num)" },
                  {
                    aggregate: [
                      { op: "sum", field: "area_num", as: "area_sum" },
                    ],
                    groupby: ["year"],
                  },
                  { filter: "datum.year == yr" },
                ],
                mark: { type: "rule", color: "#9a3412", strokeDash: [6, 4] },
                encoding: {
                  x: { field: "year", type: "quantitative" },
                },
              },
              // Text label for selected year
              {
                data: { url: "forest_reserve_state.csv" },
                transform: [
                  { calculate: nameNormalize, as: "state_norm" },
                  {
                    calculate: "toNumber(slice(toString(datum.date),0,4))",
                    as: "year",
                  },
                  { filter: "isFinite(datum.year)" },
                  {
                    filter:
                      "sel_state == 'All' || datum.state_norm == sel_state",
                  },
                  { calculate: "toNumber(datum.area)", as: "area_num" },
                  { filter: "isFinite(datum.area_num)" },
                  {
                    aggregate: [
                      { op: "sum", field: "area_num", as: "area_sum" },
                    ],
                    groupby: ["year"],
                  },
                  { filter: "datum.year == yr" },
                  {
                    calculate:
                      "'Year '+datum.year+': '+format(datum.area_sum, ',')+' ha'",
                    as: "label",
                  },
                ],
                mark: {
                  type: "text",
                  align: "left",
                  dx: 6,
                  dy: -6,
                  color: "#9a3412",
                },
                encoding: {
                  x: { field: "year", type: "quantitative" },
                  y: { field: "area_sum", type: "quantitative" },
                  text: { field: "label" },
                },
              },
            ],
          },
        ],
      };

      vegaEmbed("#vis", spec, {
        actions: { export: true, source: false, editor: true },
      });
    </script>
  </body>
</html>
